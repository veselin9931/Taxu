(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{xDpq:function(t,e,i){"use strict";i.r(e),i.d(e,"HttpLoaderFactory",function(){return $}),i.d(e,"DrivingModePageModule",function(){return _});var r=i("ofXK"),n=i("3Pt+"),s=i("TEn/"),o=i("tyNb"),c=i("mrSG"),a=i("fXoL"),l=i("gcOT"),d=i("VeQZ"),b=i("oXKM"),u=i("Gpoy"),h=i("AytR"),p=i("8k+r"),g=i("8Xdb"),v=i("e7jj"),m=i("Hmjx"),f=i("exMm"),w=i("RX8M"),M=i("z6cu"),S=i("JIr8"),y=i("tk/3"),D=i("Dsd+");let O=(()=>{class t{constructor(t,e){this.http=t,this.sharedService=e}getTotalProfit(){const t=this.sharedService.headerGerneration();return this.http.get(`${h.a.apiUrl}/api/profit`,{headers:t}).pipe(Object(S.a)(this.handleError))}addToProfit(t){const e=this.sharedService.headerGerneration();return this.http.put(`${h.a.apiUrl}/api/profit/${t}`,{headers:e,responseType:"json"}).pipe(Object(S.a)(this.handleError))}handleError(t){let e="";return t.error instanceof ErrorEvent?(console.log("Client side error."),e=`Error: ${t.error.message}`):(console.log("Server side error."),e=`Error Code: ${t.status}\nMessage: ${t.message}`),console.log(e),Object(M.a)(e)}}return t.\u0275fac=function(e){return new(e||t)(a.Rb(y.a),a.Rb(D.a))},t.\u0275prov=a.Gb({token:t,factory:t.\u0275fac,providedIn:"root"}),t})();var N=i("sYmb"),C=i("Wwn5");const x=["map"];function I(t,e){if(1&t){const t=a.Ob();a.Nb(0,"button",28),a.Vb("click",function(){return a.jc(t),a.Xb().onTheAddress()}),a.pc(1),a.Yb(2,"translate"),a.Mb()}2&t&&(a.zb(1),a.qc(a.Zb(2,1,"Im on the address")))}function P(t,e){if(1&t){const t=a.Ob();a.Nb(0,"button",16),a.Vb("click",function(){return a.jc(t),a.Xb().cancelOrder()}),a.pc(1),a.Yb(2,"translate"),a.Mb()}2&t&&(a.zb(1),a.rc(" ",a.Zb(2,1,"Cancel")," "))}function k(t,e){1&t&&(a.Nb(0,"ul",29),a.Nb(1,"li"),a.pc(2),a.Yb(3,"translate"),a.Mb(),a.Mb()),2&t&&(a.zb(2),a.qc(a.Zb(3,1,"No messages for now")))}function T(t,e){if(1&t&&(a.Nb(0,"ul"),a.Nb(1,"li",30),a.pc(2),a.Mb(),a.Mb()),2&t){const t=e.$implicit,i=a.Xb();a.zb(1),a.dc("ngClass",t.user===i.msgDto.user?"in-msg":"ex-msg"),a.zb(1),a.sc(" ",t.user,": ",t.text," ")}}const{Geolocation:L}=l.c,V=[{path:"",component:(()=>{class t{constructor(t,e,i,r,n,s,o,c,a,l,b,u){this.route=t,this.orderService=e,this.accountService=i,this.tripService=r,this.walletService=n,this.driverService=s,this.chatService=o,this.profitService=c,this.translate=a,this.popoverController=l,this.alertController=b,this.callNumber=u,this.driverId=this.tripService.currentTripDriverId,this.applicationUserId=this.accountService.userValue.id,this.isDrivingNow=this.accountService.userValue.isDrivingNow,this.orders=[],this.closestOrders=[],this.messages=this.chatService.messages,this.chatStyle="",this.orderDiv=document.getElementById("orderDiv"),this.subscriptions=[],this.msgDto=new d.c,this.msgInboxArray=[],this.translate.setDefaultLang(this.accountService.userValue.choosenLanguage)}ngOnInit(){this.id=setInterval(()=>{this.watchPos()},3e3),this.getAcceptedTrip(),this.isStarted=!1,this.subscriptions.push(this.chatService.retrieveMappedObject().subscribe(t=>{this.addToInbox(t)}));const t=(new u.b).configureLogging(u.c.Information).withUrl(`${h.a.signalRUrl}/orderHub`).build();t.start().then(function(){console.log("signalR Connected in driving-mode")}).catch(function(e){console.log("Reconnecting in 1 sec."),setTimeout(()=>t.start(),1e3)}),t.on("OrderDeleted",t=>{this.subscriptions.push(this.orderService.getCanceledOrderById(t).subscribe(t=>{t.acceptedBy==this.applicationUserId&&this.canceledOrder()}))}),t.on("OrderAccepted",t=>{this.subscriptions.push(this.orderService.getOrderById(t).subscribe(t=>{t.acceptedBy==this.applicationUserId&&this.getAcceptedTrip()}))}),t.on("Navigate",t=>{this.subscriptions.push(this.orderService.getOrderById(t).subscribe(t=>{t.acceptedBy==this.applicationUserId&&this.getAcceptedTrip()}))}),t.on("LocateDriver",t=>{}),t.on("WalletAction",()=>{}),t.on("CompleteOrder",()=>{})}ngOnDestroy(){this.id&&clearInterval(this.id)}ionViewDidEnter(){1==this.accountService.userValue.isDrivingNow&&this.getAcceptedTrip()}callDriver(){return Object(c.a)(this,void 0,void 0,function*(){let t=this.order.applicationUser.phone.toString();this.callNumber.callNumber(t,!0).then(t=>console.log("Launched dialer!",t)).catch(t=>console.log("Error launching dialer",t))})}watchPos(){return Object(c.a)(this,void 0,void 0,function*(){let t=yield L.getCurrentPosition();const e={lat:t.coords.latitude,lng:t.coords.longitude};this.subscriptions.push(this.driverService.locateDriver(this.accountService.userValue.driverId,e.lat.toString(),e.lng.toString()).subscribe(t=>{}))})}navigateToUserAndCalculateDistance(){return Object(c.a)(this,void 0,void 0,function*(){const t=new google.maps.DirectionsService,e=new google.maps.DirectionsRenderer,i=yield L.getCurrentPosition(),r={lat:i.coords.latitude,lng:i.coords.longitude};let n=+this.order.locationLat,s=+this.order.locationLong;t.route({origin:{lat:r.lat,lng:r.lng},destination:{lat:n,lng:s},travelMode:google.maps.TravelMode.DRIVING},(t,i)=>{"OK"===i?this.subscriptions.push(this.tripService.navigateToUser(this.currentTrip.id,this.order.id).subscribe(()=>{"ios"===l.a.getPlatform()&&(window.open(`http://maps.apple.com/maps?q=${n},${s}&t=m&dirflg=d`),console.log("ios platform"),e.setDirections(t),this.isStarted=!0),window.open(`https://www.google.com/maps/dir/?api=1&destination=${n},${s}&travelmode=driving`),e.setDirections(t),this.isStarted=!0})):window.alert("Directions request failed due to "+i)}),e.setMap(this.map)})}navigateToPointAndCalculateDistance(){return Object(c.a)(this,void 0,void 0,function*(){const t=new google.maps.DirectionsService,e=new google.maps.DirectionsRenderer,i=yield L.getCurrentPosition(),r={lat:i.coords.latitude,lng:i.coords.longitude};let n=+this.order.destinationLat,s=+this.order.destinationLong;t.route({origin:{lat:r.lat,lng:r.lng},destination:{lat:n,lng:s},travelMode:google.maps.TravelMode.DRIVING},(t,i)=>{"OK"===i?("ios"==l.a.getPlatform()&&(console.log("ios platform"),e.setDirections(t),window.open(`http://maps.apple.com/maps?q=${n},${s}&t=m&dirflg=d`)),"android"==l.a.getPlatform()?(console.log("android or web platform"),e.setDirections(t),window.open(`https://www.google.com/maps/dir/?api=1&destination=${n},${s}&travelmode=driving`)):(console.log("web platform"),e.setDirections(t),window.open(`https://www.google.com/maps/dir/?api=1&destination=${n},${s}&travelmode=driving`)),this.startTrip()):(console.log("failed"),window.alert("Directions request failed due to "+i))}),e.setMap(this.map)})}send(){if(this.msgDto){if(0==this.msgDto.text.length)return void window.alert("Text field is required.");this.msgDto.user=`${this.accountService.userValue.firstName} ${this.accountService.userValue.lastName}`,this.chatService.broadcastMessage(this.msgDto)}}clearMessages(){this.messages.length=0}addToInbox(t){let e=new d.c;e.user=t.user,e.text=t.text,this.msgInboxArray.push(e),this.msgDto.text=""}startTrip(){this.subscriptions.push(this.tripService.startTrip(this.currentTrip.id).subscribe(t=>{t&&(this.tripStatus=t.status,this.subscriptions.push(this.walletService.dischargeWallet(this.applicationUserId,this.tripPriceForDriver).subscribe(t=>{this.subscriptions.push(this.profitService.addToProfit(this.tripPriceForDriver).subscribe(()=>{}))})))}))}finishTrip(){this.completeTripAlert()}openLanguagePopover(t){return Object(c.a)(this,void 0,void 0,function*(){const e=yield this.popoverController.create({component:b.a,event:t});yield e.present()})}calculateEta(t){return Object(c.a)(this,void 0,void 0,function*(){const e=new google.maps.DirectionsService,i=yield L.getCurrentPosition(),r={lat:i.coords.latitude,lng:i.coords.longitude};e.route({origin:{lat:r.lat,lng:r.lng},destination:{lat:+t.locationLat,lng:+t.locationLong},travelMode:google.maps.TravelMode.DRIVING},(e,i)=>{"OK"===i&&(this.eta=e.routes[0].legs[0].duration.text,t.km=e.routes[0].legs[0].distance.value/1e3,t.distanceText=e.routes[0].legs[0].distance.text,t.eta=e.routes[0].legs[0].duration.text,this.distance=t.distanceText)})})}getAcceptedTrip(){this.subscriptions.push(this.tripService.getTrip(this.driverId).subscribe(t=>{null!=t&&(this.chatService.stop(),this.chatService.start(),this.tripStatus=t.status,this.currentTrip=t,this.subscriptions.push(this.orderService.getOrderById(t.orderId).subscribe(e=>{null!=e&&(t.order=e,this.order=t.order,this.location=e.location,this.destination=e.destination,this.totalPrice=e.totalPrice,this.userLatitude=e.locationLat,this.userLongitude=e.locationLong,this.userDestinationLat=e.destinationLat,this.userDestinationLng=e.destinationLong,this.tripDistance=e.tripDistance,this.calculateEta(e),this.subscriptions.push(this.driverService.getDriver(this.accountService.userValue.driverId).subscribe(t=>{this.tripPriceForDriver=e.totalPrice*(t.comission/100)})))})))}))}onTheAddress(){this.subscriptions.push(this.orderService.updateDriverArrived(this.order.id).subscribe(()=>{}))}cancelOrder(){this.alertForCancel()}alertForCancel(){return Object(c.a)(this,void 0,void 0,function*(){this.translate.get(["Are you sure you want to cancel the order?","Your rating will decrease!","Confirm","Cancel"]).subscribe(t=>Object(c.a)(this,void 0,void 0,function*(){const e=yield this.alertController.create({header:t["Are you sure you want to cancel the order?"],message:t["Your rating will decrease!"],buttons:[{text:t.Confirm,handler:()=>{this.subscriptions.push(this.driverService.cancelOrderFromDriver(this.order.id).subscribe(t=>{this.subscriptions.push(this.tripService.cancelTrip(this.currentTrip.id).subscribe(()=>{this.accountService.userValue.isDrivingNow=!1,this.subscriptions.push(this.accountService.updateDriving(this.applicationUserId,!1).subscribe(()=>{this.subscriptions.push(this.driverService.voteDown(this.accountService.userValue.driverId).subscribe(()=>{this.route.navigate(["menu/driving"])}))}))}))}))}},{text:t.Cancel,role:"cancel"}]});yield e.present()}))})}canceledOrder(){return Object(c.a)(this,void 0,void 0,function*(){this.translate.get(["Order is cancelled by the customer."]).subscribe(t=>Object(c.a)(this,void 0,void 0,function*(){const e=yield this.alertController.create({header:t["Order is cancelled by the customer."],buttons:[{text:"Ok",handler:()=>{this.accountService.userValue.isDrivingNow=!1,this.subscriptions.push(this.accountService.updateDriving(this.applicationUserId,!1).subscribe(()=>{this.route.navigate(["menu/driving"])}))}}]});yield e.present()}))})}completeTripAlert(){return Object(c.a)(this,void 0,void 0,function*(){this.translate.get(["Are you sure you want to finish the trip?","Yes","No"]).subscribe(t=>Object(c.a)(this,void 0,void 0,function*(){const e=yield this.alertController.create({cssClass:"my-custom-class",header:t["Are you sure you want to finish the trip?"],buttons:[{text:t.Yes,role:"cancel",handler:()=>{this.subscriptions.push(this.tripService.completeTrip(this.currentTrip.id).subscribe(t=>{t&&(this.tripStatus=t.status),this.subscriptions.push(this.orderService.completeOrder(this.currentTrip.orderId).subscribe(()=>{}));let e=this.accountService.userValue.id,i=this.accountService.userValue.isDrivingNow=!1;this.subscriptions.push(this.accountService.updateDriving(e,i).subscribe()),this.isDrivingNow=this.accountService.userValue.isDrivingNow,this.route.navigate(["menu/driving"])}))}},{text:t.No}]});yield e.present()}))})}}return t.\u0275fac=function(e){return new(e||t)(a.Kb(o.f),a.Kb(p.a),a.Kb(g.a),a.Kb(v.a),a.Kb(m.a),a.Kb(f.a),a.Kb(w.a),a.Kb(O),a.Kb(N.d),a.Kb(s.H),a.Kb(s.a),a.Kb(C.a))},t.\u0275cmp=a.Eb({type:t,selectors:[["app-driving-mode"]],viewQuery:function(t,e){if(1&t&&a.vc(x,1,a.m),2&t){let t;a.hc(t=a.Wb())&&(e.mapRef=t.first)}},decls:57,vars:28,consts:[["slot","start"],["slot","end"],["id","toolbarIcon","name","language-outline",3,"click"],["padding","",1,"noScroll"],[1,"col-md-10"],["id","orderDiv",1,"list-group","mt-2"],[1,"text","list-group-item","list-group-item-action","flex-column","align-items-start"],[1,"d-flex","w-100","justify-content-between"],[1,"mb-1","fonted"],["name","analytics-outline",1,"mr-2"],["name","arrow-forward-outline",1,"mr-2"],[1,"text-center"],["type","button",1,"fonted","btn","btn-info","btn-sm","btn-block",3,"disabled","click"],["type","button","color","primary",1,"fonted","btn","btn-info","btn-sm","btn-block",3,"disabled","click"],["type","button",1,"fonted","btn","btn-success","btn-sm","btn-block",3,"disabled","click"],["type","button","class","fonted btn btn-info btn-sm btn-block",3,"click",4,"ngIf"],["type","button",1,"fonted","btn","btn-warning","btn-sm","btn-block",3,"click"],["name","call",1,"mr-2"],["class","fonted btn btn-warning btn-sm btn-block","type","button",3,"click",4,"ngIf"],[1,"ion-no-border","page-wrap"],["id","chat",1,"row","chat"],[1,"col"],[1,"msg-box"],["class","text-center mr-5",4,"ngIf"],[4,"ngFor","ngForOf"],[1,"type"],[3,"ngModel","placeholder","ngModelChange"],["name","send-outline",3,"click"],["type","button",1,"fonted","btn","btn-info","btn-sm","btn-block",3,"click"],[1,"text-center","mr-5"],[3,"ngClass"]],template:function(t,e){1&t&&(a.Nb(0,"ion-header"),a.Nb(1,"ion-toolbar"),a.Nb(2,"ion-buttons",0),a.Lb(3,"ion-menu-button"),a.Mb(),a.Nb(4,"ion-title"),a.Nb(5,"ion-label"),a.pc(6),a.Yb(7,"translate"),a.Mb(),a.Mb(),a.Nb(8,"ion-buttons",1),a.Nb(9,"ion-icon",2),a.Vb("click",function(t){return e.openLanguagePopover(t)}),a.Mb(),a.Mb(),a.Mb(),a.Mb(),a.Nb(10,"ion-content",3),a.Nb(11,"div",4),a.Nb(12,"div",5),a.Nb(13,"a",6),a.Nb(14,"div",7),a.Lb(15,"h5",8),a.Mb(),a.Nb(16,"p"),a.Lb(17,"ion-icon",9),a.pc(18),a.Mb(),a.Lb(19,"hr"),a.Nb(20,"p"),a.Lb(21,"ion-icon",10),a.pc(22),a.Mb(),a.Nb(23,"div",11),a.Nb(24,"p"),a.Nb(25,"button",12),a.Vb("click",function(){return e.navigateToUserAndCalculateDistance()}),a.pc(26),a.Yb(27,"translate"),a.Mb(),a.Mb(),a.Nb(28,"p"),a.Nb(29,"button",13),a.Vb("click",function(){return e.navigateToPointAndCalculateDistance()}),a.pc(30),a.Yb(31,"translate"),a.Mb(),a.Mb(),a.Nb(32,"p"),a.Nb(33,"button",14),a.Vb("click",function(){return e.finishTrip()}),a.pc(34),a.Yb(35,"translate"),a.Mb(),a.Mb(),a.Nb(36,"p"),a.oc(37,I,3,3,"button",15),a.Mb(),a.Nb(38,"p"),a.Nb(39,"button",16),a.Vb("click",function(){return e.callDriver()})("click",function(){return e.clearMessages()}),a.Lb(40,"ion-icon",17),a.pc(41),a.Yb(42,"translate"),a.Mb(),a.Mb(),a.Nb(43,"p"),a.oc(44,P,3,3,"button",18),a.Mb(),a.Mb(),a.Mb(),a.Mb(),a.Mb(),a.Mb(),a.Nb(45,"ion-footer",19),a.Nb(46,"div",20),a.Nb(47,"div",21),a.Nb(48,"ion-card"),a.Nb(49,"div",22),a.oc(50,k,4,3,"ul",23),a.oc(51,T,3,3,"ul",24),a.Mb(),a.Mb(),a.Nb(52,"ion-card",25),a.Nb(53,"ion-item"),a.Nb(54,"ion-input",26),a.Vb("ngModelChange",function(t){return e.msgDto.text=t}),a.Yb(55,"translate"),a.Mb(),a.Nb(56,"ion-icon",27),a.Vb("click",function(){return e.send()}),a.Mb(),a.Mb(),a.Mb(),a.Mb(),a.Mb(),a.Mb()),2&t&&(a.zb(6),a.qc(a.Zb(7,16,"Accepted order")),a.zb(12),a.rc("",e.location," "),a.zb(4),a.rc("",e.destination," "),a.zb(3),a.dc("disabled","Started"==e.tripStatus),a.zb(1),a.qc(a.Zb(27,18,"Navigate to user")),a.zb(3),a.dc("disabled","!Processing"==e.tripStatus),a.zb(1),a.qc(a.Zb(31,20,"Start trip")),a.zb(3),a.dc("disabled","Processing"==e.tripStatus),a.zb(1),a.rc(" ",a.Zb(35,22,"Finish trip"),""),a.zb(3),a.dc("ngIf","Navigating"==e.tripStatus),a.zb(4),a.rc("",a.Zb(42,24,"Call passenger")," "),a.zb(3),a.dc("ngIf","Processing"==e.tripStatus),a.zb(6),a.dc("ngIf",0==e.msgInboxArray.length),a.zb(1),a.dc("ngForOf",e.msgInboxArray),a.zb(3),a.dc("ngModel",e.msgDto.text)("placeholder",a.Zb(55,26,"Type your message...")))},directives:[s.l,s.B,s.e,s.s,s.A,s.p,s.m,s.i,r.l,s.k,s.f,r.k,s.o,s.n,s.K,n.h,n.j,r.j],pipes:[N.c],styles:["ion-content[_ngcontent-%COMP%]{--ion-background-color:#e9e9e9}ion-toolbar[_ngcontent-%COMP%]{--ion-background-color:#eee}ion-title[_ngcontent-%COMP%]{text-align:center}#toolbarIcon[_ngcontent-%COMP%]{font-size:1.7em}.fonted[_ngcontent-%COMP%]{font-family:Open Sans Light}.centered[_ngcontent-%COMP%]{text-align:center}.text[_ngcontent-%COMP%]{font-family:Open Sans Light}hr[_ngcontent-%COMP%]{background:#eee;width:70%!important}.blink_me[_ngcontent-%COMP%]{-webkit-animation:blinker 1s linear infinite;animation:blinker 1s linear infinite}@-webkit-keyframes blinker{50%{opacity:0}}@keyframes blinker{50%{opacity:0}}.msg-box[_ngcontent-%COMP%]{width:100%;height:140px;padding:10px 30px;font-size:14px;font-family:Open Sans Light;overflow:auto}.msg-box[_ngcontent-%COMP%]   ul[_ngcontent-%COMP%]{margin:-5px;list-style:none}.msg-box[_ngcontent-%COMP%]   ul[_ngcontent-%COMP%]   .ex-msg[_ngcontent-%COMP%]{text-align:right}.msg-box[_ngcontent-%COMP%]   ul[_ngcontent-%COMP%]   .in-msg[_ngcontent-%COMP%]{text-align:left;margin-left:-60px}"]}),t})()}];let j=(()=>{class t{}return t.\u0275fac=function(e){return new(e||t)},t.\u0275mod=a.Ib({type:t}),t.\u0275inj=a.Hb({imports:[[o.h.forChild(V)],o.h]}),t})();var A=i("mqiu"),z=i("QhVT");function $(t){return new A.a(t)}let _=(()=>{class t{}return t.\u0275fac=function(e){return new(e||t)},t.\u0275mod=a.Ib({type:t}),t.\u0275inj=a.Hb({providers:[C.a],imports:[[r.b,n.e,s.C,j,N.b.forChild({loader:{provide:N.a,useFactory:$,deps:[y.a]}}),z.LanguagePopoverPageModule]]}),t})()}}]);